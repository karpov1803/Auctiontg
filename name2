# bot.py
import asyncio
import aiohttp
import re
import logging
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
from aiogram.types import FSInputFile, KeyboardButton, ReplyKeyboardMarkup

# â”€â”€â”€â”€â”€â”€â”€â”€ Ğ’Ğ¡Ğ¢ĞĞ’Ğ¬ Ğ¡Ğ’ĞĞ˜ Ğ”ĞĞĞĞ«Ğ• â”€â”€â”€â”€â”€â”€â”€â”€
TOKEN = "777777777:AAE..."          # â† Ñ‚Ğ²Ğ¾Ğ¹ Ñ‚Ğ¾ĞºĞµĞ½
ALLOWED_ID = 123456789              # â† Ñ‚Ğ²Ğ¾Ğ¹ Telegram ID
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

BASE_URL = "https://raw.githubusercontent.com/karpov1803/name/main/"
GITHUB_URL = "https://github.com/karpov1803/name"

bot = Bot(token=TOKEN)
dp = Dispatcher()

task = None
stop_event = None
current_file = None

# â”€â”€â”€â”€â”€â”€â”€â”€ ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº .txt Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² â”€â”€â”€â”€â”€â”€â”€â”€
async def get_file_list():
    async with aiohttp.ClientSession() as s:
        async with s.get(GITHUB_URL) as r:
            html = await r.text()
    return re.findall(r'/blob/main/([^"]+\.txt)"', html)

# â”€â”€â”€â”€â”€â”€â”€â”€ ĞšĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ° Ñ Ñ„Ğ°Ğ¹Ğ»Ğ°Ğ¼Ğ¸ â”€â”€â”€â”€â”€â”€â”€â”€
async def files_kb():
    files = await get_file_list()
    buttons = [KeyboardButton(text=f"ğŸ“„ {f}") for f in files]
    buttons += [
        KeyboardButton(text="ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº"),
        KeyboardButton(text="Ğ¡Ğ¢ĞĞ Ğ¢"),
        KeyboardButton(text="Ğ¡Ğ¢ĞĞŸ"),
        KeyboardButton(text="Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ")
    ]
    # â† ĞĞ”ĞĞ Ğ¿Ğ°Ñ€Ğ° ĞºĞ²Ğ°Ğ´Ñ€Ğ°Ñ‚Ğ½Ñ‹Ñ… ÑĞºĞ¾Ğ±Ğ¾Ğº!
    return ReplyKeyboardMarkup(
        keyboard=[buttons[i:i+2] for i in range(0, len(buttons), 2)],
        resize_keyboard=True
    )

# â”€â”€â”€â”€â”€â”€â”€â”€ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ÑĞ¿Ğ¸ÑĞºĞ° â”€â”€â”€â”€â”€â”€â”€â”€
async def load_usernames(name):
    url = BASE_URL + name
    async with aiohttp.ClientSession() as s:
        async with s.get(url) as r:
            if r.status != 200: return []
            text = await r.text()
    return [line.strip() for line in text.splitlines() if line.strip() and len(line.strip()) >= 5]

# â”€â”€â”€â”€â”€â”€â”€â”€ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¸Ğ¼ĞµĞ½Ğ¸ â”€â”€â”€â”€â”€â”€â”€â”€
async def check(name, session):
    if stop_event.is_set(): return None
    try:
        async with session.get(f"https://fragment.com/username/{name.lower()}", timeout=8) as r:
            if "available" not in await r.text(): return None
        async with session.get(f"https://t.me/{name}", timeout=8) as r:
            if "empty" not in await r.text(): return None
        return name
    except:
        return None

# â”€â”€â”€â”€â”€â”€â”€â”€ ĞÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° â”€â”€â”€â”€â”€â”€â”€â”€
async def start_checking(message: types.Message, file_name):
    global task, stop_event, current_file
    if task and not task.done():
        return await message.answer("Ğ£Ğ¶Ğµ Ğ¸Ğ´Ñ‘Ñ‚ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°!")
    
    current_file = file_name
    stop_event = asyncio.Event()
    usernames = await load_usernames(file_name)
    if not usernames:
        return await message.answer("Ğ¤Ğ°Ğ¹Ğ» Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹")

    await message.answer(
        f"Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºÑƒ\nğŸ“„ {file_name}\nĞ’ÑĞµĞ³Ğ¾: {len(usernames)}",
        reply_markup=types.ReplyKeyboardRemove()
    )
    
    free = []
    async with aiohttp.ClientSession() as session:
        for i, name in enumerate(usernames, 1):
            if stop_event.is_set():
                await message.answer("ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾!")
                break
            res = await check(name, session)
            if res:
                free.append(res)
                await message.answer(f"@{res}")
            if i % 15 == 0:
                await message.answer(f"{i}/{len(usernames)}")
            await asyncio.sleep(1.1)

    if free:
        path = "free.txt"
        with open(path, "w", encoding="utf-8") as f:
            f.write("\n".join(f"@{x}" for x in free))
        await message.answer(f"Ğ“ĞĞ¢ĞĞ’Ğ! ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ¾: {len(free)}")
        await bot.send_document(message.chat.id, FSInputFile(path), caption=file_name)
    else:
        await message.answer("ĞĞ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾")

    task = None
    await message.answer("Ğ“Ğ¾Ñ‚Ğ¾Ğ² Ğº Ğ½Ğ¾Ğ²Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞµ!", reply_markup=await files_kb())

# â”€â”€â”€â”€â”€â”€â”€â”€ Ğ¥ÑĞ½Ğ´Ğ»ĞµÑ€Ñ‹ â”€â”€â”€â”€â”€â”€â”€â”€
@dp.message(Command("start"))
async def start(m: types.Message):
    if m.from_user.id != ALLOWED_ID:
        return await m.answer("Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğ·Ğ°Ğ¿Ñ€ĞµÑ‰Ñ‘Ğ½")
    await m.answer(
        "ĞŸÑ€Ğ¸Ğ²ĞµÑ‚!\nĞ’Ñ‹Ğ±ĞµÑ€Ğ¸ Ñ„Ğ°Ğ¹Ğ» Ğ¸Ğ· Ğ¿Ğ°Ğ¿ĞºĞ¸ â†’ Ğ¡Ğ¢ĞĞ Ğ¢",
        reply_markup=await files_kb()
    )

@dp.message(lambda m: m.text and m.text.startswith("ğŸ“„ "))
async def select_file(m: types.Message):
    global current_file
    current_file = m.text[2:].strip()
    await m.answer(
        f"Ğ’Ñ‹Ğ±Ñ€Ğ°Ğ½: {current_file}\nĞ–Ğ¼Ğ¸ Ğ¡Ğ¢ĞĞ Ğ¢",
        reply_markup=ReplyKeyboardMarkup(
            keyboard=[[KeyboardButton("Ğ¡Ğ¢ĞĞ Ğ¢"), KeyboardButton("Ğ¡Ğ¢ĞĞŸ")]],
            resize_keyboard=True
        )
    )

@dp.message(lambda m: m.text == "Ğ¡Ğ¢ĞĞ Ğ¢")
async def btn_start(m: types.Message):
    if not current_file:
        return await m.answer("Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸ Ñ„Ğ°Ğ¹Ğ»!")
    global task
    task = asyncio.create_task(start_checking(m, current_file))

@dp.message(lambda m: m.text == "Ğ¡Ğ¢ĞĞŸ")
async def btn_stop(m: types.Message):
    global task, stop_event
    if stop_event: stop_event.set()
    if task: task.cancel()
    await m.answer("ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾!")

@dp.message(lambda m: m.text == "ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº")
async def refresh(m: types.Message):
    await m.answer("ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑÑ...", reply_markup=await files_kb())

@dp.message(lambda m: m.text == "Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ")
async def status(m: types.Message):
    if task and not task.done():
        await m.answer("ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¸Ğ´Ñ‘Ñ‚...")
    else:
        await m.answer(f"Ğ¤Ğ°Ğ¹Ğ»: {current_file or 'Ğ½Ğµ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½'}")

# â”€â”€â”€â”€â”€â”€â”€â”€ Ğ—Ğ°Ğ¿ÑƒÑĞº â”€â”€â”€â”€â”€â”€â”€â”€
async def main():
    logging.basicConfig(level=logging.INFO)
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())